<!-- upload.html -->
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mest uploaden – MestAssistent</title>
  <link rel="stylesheet" href="style.css"/>

  <!-- Supabase in head (zoals op je andere pagina's) -->
  <script type="module" src="supabaseClient.js"></script>

  <!-- Pagina-specifieke (scoped) form styles -->
  <style>
    .container { max-width: 980px; margin: 0 auto; padding: 1rem; }
    .card { background:#fff; border-radius: 14px; padding: 1.25rem; box-shadow: 0 10px 30px rgba(0,0,0,.06); margin-bottom: 1.25rem; }
    .form-grid { display: grid; gap: 1rem; }
    @media (min-width: 720px){ .cols-2 { grid-template-columns: 1fr 1fr; } }
    .form-section { border: 1px solid #f1f1f1; border-radius: 12px; padding: 1rem; background: #fafafa; }
    .section-header { display: flex; align-items: center; gap: .5rem; margin-bottom: .75rem; }
    .step-badge { display:inline-flex; align-items:center; justify-content:center; min-width:26px; height:26px; padding:0 6px; border-radius: 999px; background: var(--color-yellow); color: var(--color-black); font-weight: 700; font-size:.9rem; }
    .section-title { margin:0; font-size:1.05rem; }

    .field { display:flex; flex-direction: column; gap: .35rem; }
    .label { font-weight: 600; color: var(--color-black); }
    .hint { color:#6b7280; font-size:.9rem; }
    .control { position: relative; }
    .input, .select, .file {
      width:100%; border:1px solid #e5e7eb; background:#fff; color:#111827;
      border-radius: 10px; padding: .7rem .85rem; outline: none;
      transition: border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
    }
    .input:focus, .select:focus, .file:focus {
      border-color: var(--color-yellow);
      box-shadow: 0 0 0 3px rgba(241,196,15,.25);
      background:#fff;
    }
    .input[readonly] { background: #f9fafb; color:#4b5563; }

    /* input met addon (€, ton) */
    .addon-wrap { position: relative; }
    .addon { position:absolute; left:.6rem; top:50%; transform: translateY(-50%); color:#6b7280; font-weight:600; }
    .addon-right { left:auto; right:.6rem; }
    .addon-wrap .input { padding-left: 2rem; }
    .addon-wrap .input.addon-right-pad { padding-right: 2.2rem; }

    /* tabel overzicht */
    table { width:100%; border-collapse: collapse; }
    th, td { padding:.65rem; border-bottom: 1px solid #eee; vertical-align: top; }
    .right { text-align:right; }

    /* Mestselectie-knoppen (zelfde look als mestplan) */
    .category { display:flex; align-items:flex-start; gap:.75rem; flex-wrap:wrap; margin-bottom: .75rem; }
    .category__label { width: 140px; min-width:140px; font-weight:700; font-size:.95rem; padding-top:.35rem; }
    .category__choices { display:flex; flex-wrap:wrap; gap:.35rem; }
    .btn.mest-btn { border: 2px solid var(--color-black); background: var(--color-white); color: var(--color-black); padding:.5rem .8rem; border-radius: 8px; font-size:.92rem; cursor:pointer; transition: background .18s, border-color .18s, transform .08s; }
    .btn.mest-btn:hover { transform: translateY(-1px); }
    .category input[type="radio"] { position:absolute; opacity:0; pointer-events:none; width:0; height:0; }
    .category input[type="radio"]:checked + label { background: var(--color-yellow); border-color: var(--color-yellow); }
    .category input[type="radio"]:focus + label { outline: 3px solid rgba(241,196,15,.35); outline-offset: 2px; }

    /* Sign segmented control (vraagprijs ±) */
    .segmented { display:inline-flex; border:1px solid #e5e7eb; border-radius: 10px; overflow:hidden; background:#fff; }
    .segmented button {
      appearance: none; border:0; background:transparent; padding:.55rem .8rem; font-weight:600; cursor:pointer;
    }
    .segmented button[aria-pressed="true"] { background: var(--color-yellow); color: var(--color-black); }
    .segmented button:focus-visible { outline:3px solid rgba(241,196,15,.35); outline-offset: -2px; }

    .actions { display:flex; gap:.75rem; flex-wrap:wrap; }
    .muted { color:#6b7280; font-size:.9rem; }

    /* Postcode toggle rij */
    .inline-toggle { display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; }
    .inline-toggle .field { flex: 1 1 280px; margin: 0; }

    /* kleine badge voor status */
    .status-note { font-size:.9rem; color:#6b7280; }

    /* fout-styles (worden vanuit utils gezet) */
    .input-error { border-color: #c62828; }
    [data-error]::after { content: attr(data-error); color: #c62828; font-size: .85rem; display:block; margin-top:.25rem; }

    /* MOBIEL: alle mestknoppen (incl. Drijfmest/Koe/Varken) full-width en identiek */
    @media (max-width:768px){
      #mestChoiceList .category{ align-items:stretch; flex-direction:column; }
      #mestChoiceList .category__label{ width:100%; min-width:0; margin-bottom:.25rem; }
      #mestChoiceList .category__choices{
        display:flex; flex-wrap:wrap; gap:.5rem;
      }
      #mestChoiceList .category__choices .btn.mest-btn{
        flex: 1 1 100% !important;
        max-width:100% !important;
        width:100% !important;
        height:44px;
        text-align:center;
        margin:0;
        box-sizing:border-box;
      }
    }
  </style>
</head>
<body>
  <!-- NAV / HEADER -->
  <header class="site-header">
    <nav class="navbar">
      <a href="index.html" class="nav-logo">KoeHandelaar</a>

      <button id="nav-toggle" class="nav-toggle" aria-label="Menu" aria-controls="site-menu" aria-expanded="false">
        <span class="bars" aria-hidden="true"></span>
      </button>

      <div id="site-menu" class="site-menu" hidden>
        <button id="nav-close" class="nav-close" aria-label="Menu sluiten">
          <span aria-hidden="true">&times;</span>
        </button>

        <ul class="nav-links">
          <li class="auth-only"><a href="stap1.html" class="nav__item" id="nav-bereken">Bereken plaatsingsruimte</a></li>
          <li class="auth-only"><a href="mestplan.html" class="nav__item" id="nav-mestplan">Maak mestplan</a></li>
          <li class="auth-only"><a href="upload.html" class="nav__item" id="nav-upload">Mest uploaden</a></li>
          <li class="auth-only"><a href="account.html" class="nav__item" id="nav-account">Mijn account</a></li>
          <li class="auth-only admin-only"><a href="beheer.html" class="nav__item" id="nav-beheer">Beheer</a></li>
          <li class="nav-auth-item"><button class="btn-login" id="nav-auth">Inloggen</button></li>
        </ul>
      </div>
    </nav>
  </header>

  <!-- MAIN -->
  <main id="main" class="container">
    <section class="card" aria-labelledby="h-upload">
      <h2 id="h-upload" style="margin-bottom:.5rem;">Mest uploaden</h2>
      <p class="muted" style="margin-bottom:1rem;">Vul de velden hieronder in. <em>De analyse upload je als laatste stap.</em></p>

      <form id="uploadForm" class="form-grid" novalidate>
        <!-- Stap 1: kies mestsoort -->
        <div class="form-section">
          <div class="section-header">
            <span class="step-badge">1</span>
            <h3 class="section-title">Kies mestsoort</h3>
          </div>
          <div id="mestChoiceList" aria-describedby="mestChoiceHelp">
            <!-- dynamisch gevuld via upload.js uit data/mestsoorten.json -->
          </div>
          <div id="mestChoiceHelp" class="hint">Je kunt <strong>één</strong> mestsoort selecteren. De waarden uit de analyse worden hieraan gekoppeld.</div>
        </div>

        <!-- Stap 2: basisgegevens -->
        <div class="form-section">
          <div class="section-header">
            <span class="step-badge">2</span>
            <h3 class="section-title">Basisgegevens</h3>
          </div>
          <div class="form-grid cols-2">
            <div class="field" style="grid-column: 1 / -1;">
              <label for="naam" class="label">Naam<span aria-hidden="true">*</span></label>
              <div class="control">
                <input id="naam" name="naam" class="input" placeholder="Bijv. Mest opslag 34" maxlength="25" required/>
              </div>
              <div class="hint">0–25 tekens. Handig: locatie of opslagnummer.</div>
            </div>
          </div>
        </div>

        <!-- Stap 3: prijs & hoeveelheid -->
        <div class="form-section">
          <div class="section-header">
            <span class="step-badge">3</span>
            <h3 class="section-title">Prijs & hoeveelheid</h3>
          </div>
          <div class="form-grid cols-2">
            <!-- Vraagprijs per ton met ± toggle -->
            <div class="field">
              <label for="inkoopprijs" class="label">Vraagprijs per ton (€)<span aria-hidden="true">*</span></label>
              <div class="control" style="display:flex; gap:.5rem; align-items:center;">
                <!-- segmented sign control -->
                <div class="segmented" data-role="price-sign" aria-label="Teken van de vraagprijs">
                  <button type="button" aria-pressed="true"  data-sign="pos" title="Ik ontvang geld (positief)">+</button>
                  <button type="button" aria-pressed="false" data-sign="neg" title="Ik betaal bij (negatief)">−</button>
                </div>
                <!-- hidden field dat upload.js leest -->
                <input type="hidden" id="priceSign" value="pos" />
                <!-- bedrag -->
                <div class="addon-wrap" style="flex:1;">
                  <span class="addon">€</span>
                  <input id="inkoopprijs" class="input" inputmode="decimal" placeholder="Bijv. 12.50" autocomplete="off" required/>
                </div>
              </div>
              <div class="hint">+ = je ontvangt; - = je geeft mee. Maximaal 2 decimalen.</div>
            </div>

            <!-- Aantal ton (altijd hele getallen) -->
            <div class="field">
              <label for="aantalTon" class="label">Aantal ton<span aria-hidden="true">*</span></label>
              <div class="control addon-wrap">
                <input id="aantalTon" class="input addon-right-pad" inputmode="numeric" placeholder="Bijv. 80" autocomplete="off" required/>
                <span class="addon addon-right">ton</span>
              </div>
              <div class="hint">Alleen hele aantallen &gt; 24 (geen decimalen).</div>
            </div>
          </div>
        </div>

        <!-- Stap 4: laadlocatie -->
        <div class="form-section">
          <div class="section-header">
            <span class="step-badge">4</span>
            <h3 class="section-title">Laadlocatie</h3>
          </div>
          <div class="inline-toggle">
            <label class="label" style="display:flex; align-items:center; gap:.5rem;">
              <input type="checkbox" id="useProfilePostcode" checked/>
              Postcode bedrijfsadres
            </label>
            <div id="postcodeWrap" class="field" style="display:none;">
              <label for="postcode" class="label">Postcode (NL)</label>
              <div class="control">
                <input id="postcode" class="input" placeholder="1234 AB" inputmode="text" autocomplete="postal-code"/>
              </div>
            </div>
          </div>
        </div>

        <!-- Stap 5: analyse (als laatste) -->
        <div class="form-section">
          <div class="section-header">
            <span class="step-badge">5</span>
            <h3 class="section-title">Analyse uploaden</h3>
          </div>

          <div class="form-grid cols-2">
            <div class="field" style="grid-column: 1 / -1;">
              <label for="file" class="label">Analysebestand (PDF/JPG/PNG) <span class="muted">(optioneel)</span></label>
              <div class="control">
                <input id="file" type="file" class="file" accept=".pdf,.png,.jpg,.jpeg"/>
              </div>
              <div class="hint">Max. 10 MB. Als je niets uploadt, gebruiken we de standaardwaarden voor de gekozen mestsoort.</div>
            </div>

            <div class="form-grid cols-2" style="grid-column: 1 / -1; margin-top:.25rem;">
              <div class="field">
                <label for="DS_percent" class="label">Droge stof (DS%)</label>
                <input id="DS_percent" class="input" readonly/>
              </div>
              <div class="field">
                <label for="N_kg_per_ton" class="label">Stikstof (N kg/ton)</label>
                <input id="N_kg_per_ton" class="input" readonly/>
              </div>
              <div class="field">
                <label for="P_kg_per_ton" class="label">Fosfaat (P kg/ton)</label>
                <input id="P_kg_per_ton" class="input" readonly/>
              </div>
              <div class="field">
                <label for="K_kg_per_ton" class="label">Kalium (K kg/ton)</label>
                <input id="K_kg_per_ton" class="input" readonly/>
              </div>
              <div class="field">
                <label for="OS_percent" class="label">Organische stof (OS%)</label>
                <input id="OS_percent" class="input" readonly/>
              </div>
              <div class="field">
                <label for="Biogas" class="label">Biogas potentieel (m³/ton)</label>
                <input id="Biogas" class="input" readonly/>
              </div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn-primary" id="btnSubmit" type="submit">Uploaden</button>
        </div>
      </form>
    </section>

    <section class="card" aria-labelledby="h-overview">
      <h2 id="h-overview" style="margin-bottom:.25rem;">Mijn uploads</h2>
      <div class="muted" style="margin-bottom:.5rem;">Wijzig hier de basisgegevens. Nutrient-waarden zijn read-only.</div>
      <div id="myUploads"></div>
    </section>

    <!-- Kaart-template voor Mijn uploads -->
    <template id="tpl-upload-card">
      <article class="upload-card upload-card--airy" data-id="">
        <button class="card-close a-del" aria-label="Verwijderen" title="Verwijderen">×</button>
        <button class="card-save a-save" aria-label="Opslaan" title="Opslaan (✓)">✓</button>
      
        <header class="upload-card__head">
          <div class="title"></div>
          <div class="status"></div>
        </header>
      
        <div class="upload-card__meta">
          <div class="meta-row">
            <div class="meta-label">Mestsoort</div>
            <div class="meta-value js-kind"></div>
          </div>
      
          <div class="meta-row">
            <div class="meta-label">Analyse</div>
            <div class="meta-value">
              <div class="analysis-pills js-analysis"></div>
            </div>
          </div>
      
          <div class="meta-row">
            <div class="meta-label">Bestand</div>
            <div class="meta-value js-filechip"></div>
          </div>
        </div>
      
        <div class="upload-card__form">
          <label class="field-sm" style="grid-column:1 / -1">
            <span class="label-sm">Naam</span>
            <input class="input input--sm e-naam" maxlength="25" placeholder="Naam van deze upload">
          </label>

          <label class="field-sm">
            <span class="label-sm">Vraagprijs per ton</span>
            <div class="control">
              <span class="addon left">€</span>
              <input class="input input--sm addon-left-pad e-prijs" inputmode="decimal" placeholder="0,00" value="">
            </div>
          </label>
      
          <label class="field-sm">
            <span class="label-sm">Aantal ton</span>
            <div class="control">
              <input class="input input--sm addon-right-pad e-ton" inputmode="numeric" placeholder="0" value="">
              <span class="addon right">t</span>
            </div>
          </label>
      
          <label class="field-sm">
            <span class="label-sm">Postcode</span>
            <div class="control">
              <input class="input input--sm e-postcode" maxlength="7" placeholder="1234 AB" value="">
            </div>
          </label>
        </div>
      </article>
    </template>
  </main>

  <footer id="footer"></footer>

  <!-- Pagina-scripts -->
  <script type="module" src="utils.js"></script>
  <script type="module" src="upload.js"></script>
  <script type="module" src="nav.js"></script>

  <!-- Nav init -->
  <script type="module">
    import { initNavMenu } from './nav-menu.js';
    initNavMenu({ menuId: 'site-menu', toggleId: 'nav-toggle' });
  </script>

  <!-- Kleine UX-masks (prijs ±, 2 decimals; ton integer; postcode 1234 AB) -->
  <script type="module">
    import { formatPostcode } from './utils.js';

    // Sign segmented control -> hidden #priceSign
    const signWrap = document.querySelector('[data-role="price-sign"]');
    const signPos  = signWrap?.querySelector('button[data-sign="pos"]');
    const signNeg  = signWrap?.querySelector('button[data-sign="neg"]');
    const signHidden = document.getElementById('priceSign');

    function setSign(mode){
      if (!signHidden) return;
      signHidden.value = mode;
      if (signPos && signNeg) {
        signPos.setAttribute('aria-pressed', String(mode === 'pos'));
        signNeg.setAttribute('aria-pressed', String(mode === 'neg'));
      }
    }
    signPos?.addEventListener('click', () => setSign('pos'));
    signNeg?.addEventListener('click', () => setSign('neg'));
    // default
    setSign('pos');

    // Prijs: 0..2 decimalen, UI toont altijd komma, geen '-' in veld (teken via toggle)
    const elPrijs = document.getElementById('inkoopprijs');
    if (elPrijs) {
      const formatPrice = (raw) => {
        if (raw == null) return '';
        let s = String(raw);
    
        // 1) converteer alle punten naar komma
        s = s.replace(/\./g, ',');
    
        // 2) filter alles behalve cijfers en komma
        s = s.replace(/[^0-9,]/g, '');
    
        // 3) houd maximaal één komma
        const i = s.indexOf(',');
        if (i !== -1) {
          const before = s.slice(0, i);
          let after = s.slice(i + 1).replace(/,/g, ''); // extra komma's weg
          after = after.slice(0, 2);                    // max 2 decimalen
          s = before + (after.length ? ',' + after : ',');
        }
        // optioneel: voorkom ",xx" → maak "0,xx"
        if (s.startsWith(',')) s = '0' + s;
    
        return s;
      };
    
      elPrijs.addEventListener('beforeinput', (e) => {
        // minteken blokkeren; teken kies je met de ±-toggle
        if (e.data === '-') e.preventDefault();
      });
    
      elPrijs.addEventListener('input', () => {
        const val = elPrijs.value;
        const formatted = formatPrice(val);
        if (formatted !== val) {
          elPrijs.value = formatted;
          // caret eenvoudig naar eind — simpel & robuust
          const end = elPrijs.value.length;
          elPrijs.setSelectionRange(end, end);
        }
      });
    
      elPrijs.addEventListener('blur', () => {
        elPrijs.value = formatPrice(elPrijs.value);
      });
    }

    // Ton: alleen hele getallen
    const elTon = document.getElementById('aantalTon');
    if (elTon) {
      elTon.addEventListener('input', () => {
        elTon.value = (elTon.value || '').replace(/\D/g,'');
      });
    }

    // Postcode live mask: "1234 AB" — spatie pas tonen als er 1+ letters zijn
    const elPC = document.getElementById('postcode');
    if (elPC) {
      // Backspace over de spatie: verwijder de spatie en zet caret goed
      elPC.addEventListener('keydown', (e) => {
        if (e.key !== 'Backspace') return;
        const start = elPC.selectionStart;
        const end   = elPC.selectionEnd;
        const val   = elPC.value;
    
        // Alleen bij caret zonder selectie, direct ná de spatie ("1234⎵AB" => index 5)
        if (start === end && start > 0 && val[start - 1] === ' ' && /^\d{4} $/.test(val.slice(0, start))) {
          e.preventDefault();
          // Verwijder de spatie en zet caret één naar links
          elPC.value = val.slice(0, start - 1) + val.slice(start);
          elPC.setSelectionRange(start - 1, start - 1);
        }
      });
    
      // Live normalisatie: 4 cijfers + optioneel spatie + max 2 hoofdletters
      elPC.addEventListener('input', () => {
        const raw = elPC.value;
        const digits  = raw.replace(/\D/g, '').slice(0, 4);
        const letters = raw.replace(/[^a-zA-Z]/g, '').toUpperCase().slice(0, 2);
    
        let out = digits;
        if (letters.length) out += ' ' + letters; // spatie alleen als er letters zijn
        elPC.value = out;
      });
    
      // Bij verlaten veld: laatste nette format
      elPC.addEventListener('blur', () => {
        const raw = elPC.value;
        const digits  = raw.replace(/\D/g, '').slice(0, 4);
        const letters = raw.replace(/[^a-zA-Z]/g, '').toUpperCase().slice(0, 2);
        elPC.value = digits + (letters ? ' ' + letters : '');
      });
    }
  </script>
</body>
</html>
