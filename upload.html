<!-- upload.html -->
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mest uploaden – MestAssistent</title>
  <link rel="stylesheet" href="style.css"/>

  <!-- Supabase in head (zoals op je andere pagina's) -->
  <script type="module" src="supabaseClient.js"></script>
</head>
<body>
  <!-- NAV / HEADER -->
  <header class="site-header">
    <nav class="navbar">
      <a href="index.html" class="nav-logo">KoeHandelaar</a>

      <button id="nav-toggle" class="nav-toggle" aria-label="Menu" aria-controls="site-menu" aria-expanded="false">
        <span class="bars" aria-hidden="true"></span>
      </button>

      <div id="site-menu" class="site-menu" hidden>
        <button id="nav-close" class="nav-close" aria-label="Menu sluiten">
          <span aria-hidden="true">&times;</span>
        </button>

        <ul class="nav-links">
          <li class="auth-only"><a href="stap1.html" class="nav__item" id="nav-bereken">Bereken plaatsingsruimte</a></li>
          <li class="auth-only"><a href="mestplan.html" class="nav__item" id="nav-mestplan">Maak mestplan</a></li>
          <li class="auth-only"><a href="upload.html" class="nav__item" id="nav-upload">Mest uploaden</a></li>
          <li class="auth-only"><a href="account.html" class="nav__item" id="nav-account">Mijn account</a></li>
          <li class="auth-only admin-only"><a href="beheer.html" class="nav__item" id="nav-beheer">Beheer</a></li>
          <li class="nav-auth-item"><button class="btn-login" id="nav-auth">Inloggen</button></li>
        </ul>
      </div>
    </nav>
  </header>

  <!-- MAIN -->
  <main id="main" class="container container--narrow">
    <section class="card" aria-labelledby="h-upload">
      <h2 id="h-upload" class="mb-050">Mest uploaden</h2>
      <p class="muted mb-100">Vul de velden hieronder in. <em>De analyse upload je als laatste stap.</em></p>

      <form id="uploadForm" class="form-grid" novalidate>
        <!-- Stap 1: kies mestsoort -->
        <div class="form-section">
          <div class="section-header">
            <span class="step-badge">1</span>
            <h3 class="section-title">Kies mestsoort</h3>
          </div>
          <div id="mestChoiceList" aria-describedby="mestChoiceHelp">
            <!-- dynamisch gevuld via upload.js uit data/mestsoorten.json -->
          </div>
          <div id="mestChoiceHelp" class="hint">Je kunt <strong>één</strong> mestsoort selecteren. De waarden uit de analyse worden hieraan gekoppeld.</div>
        </div>

        <!-- Stap 2: basisgegevens -->
        <div class="form-section">
          <div class="section-header">
            <span class="step-badge">2</span>
            <h3 class="section-title">Basisgegevens</h3>
          </div>
          <div class="form-grid cols-2">
            <div class="field col-span-2">
              <label for="naam" class="label">Naam<span aria-hidden="true">*</span></label>
              <div class="control">
                <input id="naam" name="naam" class="input" placeholder="Bijv. Mest opslag 34" maxlength="25" required/>
              </div>
              <div class="hint">0–25 tekens. Handig: locatie of opslagnummer.</div>
            </div>
          </div>
        </div>

        <!-- Stap 3: prijs & hoeveelheid -->
        <div class="form-section">
          <div class="section-header">
            <span class="step-badge">3</span>
            <h3 class="section-title">Prijs & hoeveelheid</h3>
          </div>
          <div class="form-grid cols-2">
            <div class="field">
              <label for="inkoopprijs" class="label">Vraagprijs per ton (€)<span aria-hidden="true">*</span></label>
              <div class="control control--row">
                <div class="segmented" data-role="price-sign" aria-label="Teken van de vraagprijs">
                  <button type="button" aria-pressed="true"  data-sign="pos" title="Ik ontvang geld (positief)">+</button>
                  <button type="button" aria-pressed="false" data-sign="neg" title="Ik betaal bij (negatief)">−</button>
                </div>
                <input type="hidden" id="priceSign" value="pos" />
                <div class="addon-wrap flex-1">
                  <span class="addon">€</span>
                  <input id="inkoopprijs" class="input" inputmode="decimal" placeholder="Bijv. 12.50" autocomplete="off" required/>
                </div>
              </div>
              <div class="hint">+ = je ontvangt; - = je geeft mee. Maximaal 2 decimalen.</div>
            </div>

            <div class="field">
              <label for="aantalTon" class="label">Aantal ton<span aria-hidden="true">*</span></label>
              <div class="control addon-wrap">
                <input id="aantalTon" class="input addon-right-pad" inputmode="numeric" placeholder="Bijv. 80" autocomplete="off" required/>
                <span class="addon addon-right">ton</span>
              </div>
              <div class="hint">Min. 25 ton (geen decimalen).</div>
            </div>
          </div>
        </div>

        <!-- Stap 4: laadlocatie -->
        <div class="form-section">
          <div class="section-header">
            <span class="step-badge">4</span>
            <h3 class="section-title">Laadlocatie</h3>
          </div>
          <div class="inline-toggle">
            <label class="label" style="display:flex; align-items:center; gap:.5rem;">
              <input type="checkbox" id="useProfilePostcode" checked/>
              Postcode bedrijfsadres
            </label>
            <div id="postcodeWrap" class="field" style="display:none;">
              <label for="postcode" class="label">Postcode (NL)</label>
              <div class="control">
                <input id="postcode" class="input" placeholder="1234 AB" inputmode="text" autocomplete="postal-code"/>
              </div>
            </div>
          </div>
        </div>

        <!-- Stap 5: analyse (als laatste) -->
        <div class="form-section">
          <div class="section-header">
            <span class="step-badge">5</span>
            <h3 class="section-title">Analyse uploaden</h3>
          </div>

          <div class="form-grid cols-2">
            <div class="field col-span-2">
              <label for="file" class="label">Analysebestand (PDF/JPG/PNG) <span class="muted">(optioneel)</span></label>
              <div class="control">
                <input id="file" type="file" class="file" accept=".pdf,.png,.jpg,.jpeg"/>
              </div>
              <div class="hint">Max. 10 MB. Als je niets uploadt, gebruiken we de standaardwaarden voor de gekozen mestsoort.</div>
            </div>

            <div class="form-grid cols-2 col-span-2 mt-025">
              <div class="field">
                <label for="DS_percent" class="label">Droge stof (DS%)</label>
                <input id="DS_percent" class="input" readonly/>
              </div>
              <div class="field">
                <label for="N_kg_per_ton" class="label">Stikstof (N kg/ton)</label>
                <input id="N_kg_per_ton" class="input" readonly/>
              </div>
              <div class="field">
                <label for="P_kg_per_ton" class="label">Fosfaat (P kg/ton)</label>
                <input id="P_kg_per_ton" class="input" readonly/>
              </div>
              <div class="field">
                <label for="K_kg_per_ton" class="label">Kalium (K kg/ton)</label>
                <input id="K_kg_per_ton" class="input" readonly/>
              </div>
              <div class="field">
                <label for="OS_percent" class="label">Organische stof (OS%)</label>
                <input id="OS_percent" class="input" readonly/>
              </div>
              <div class="field">
                <label for="Biogas" class="label">Biogas potentieel (m³/ton)</label>
                <input id="Biogas" class="input" readonly/>
              </div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn-primary" id="btnSubmit" type="submit">Uploaden</button>
        </div>
      </form>
    </section>

    <section class="card" aria-labelledby="h-overview">
      <h2 id="h-overview" class="mb-025">Mijn uploads</h2>
      <div class="muted mb-050">Controleer je gegevens; Nutriëntwaarden wijzig je uitsluitend met een nieuwe analyse.</div>
      <div id="myUploads"></div>
    </section>

    <!-- Kaart-template voor Mijn uploads -->
    <template id="tpl-upload-card">
      <article class="upload-card upload-card--airy" data-id="">
        <button class="card-close a-del" aria-label="Verwijderen" title="Verwijderen">×</button>

        <header class="upload-card__head">
          <div class="title"></div>
          <div class="status"></div>
        </header>

        <div class="upload-card__meta">
          <div class="meta-row">
            <div class="meta-label">Mestsoort</div>
            <div class="meta-value js-kind"></div>
          </div>

          <div class="meta-row">
            <div class="meta-label">Nutriënten</div>
            <div class="meta-value">
              <div class="analysis-pills js-analysis"></div>
            </div>
          </div>

          <div class="meta-row">
            <div class="meta-label">Analyse</div>
            <div class="meta-value js-filechip"></div>
          </div>
        </div>

        <div class="upload-card__form">
          <label class="field-sm">
            <span class="label-sm">Vraagprijs per ton</span>
            <div class="control">
              <span class="addon left">€</span>
              <input class="input input--sm addon-left-pad e-prijs" inputmode="decimal" placeholder="0,00" value="">
            </div>
          </label>

          <label class="field-sm">
            <span class="label-sm">Aantal ton</span>
            <div class="control">
              <input class="input input--sm addon-right-pad e-ton" inputmode="numeric" placeholder="0" value="">
              <span class="addon right">t</span>
            </div>
          </label>

          <label class="field-sm">
            <span class="label-sm">Postcode</span>
            <div class="control">
              <input class="input input--sm e-postcode" maxlength="7" placeholder="1234 AB" value="">
            </div>
          </label>
        </div>
      </article>
    </template>
  </main>

  <footer id="footer"></footer>

  <!-- Pagina-scripts -->
  <script type="module" src="utils.js"></script>
  <script type="module" src="upload.js"></script>
  <script type="module" src="./core/ui/nav.js"></script>

  <!-- Nav init -->
  <script type="module">
    import { initNavMenu } from './nav-menu.js';
    initNavMenu({ menuId: 'site-menu', toggleId: 'nav-toggle' });
  </script>

  <!-- Kleine UX-masks (prijs ±, 2 decimals; ton integer; postcode 1234 AB) -->
  <script type="module">
    import { formatPostcode } from './utils.js';

    // Prijs: 0..2 decimalen, UI toont altijd komma, geen '-' in veld (teken via toggle)
    const elPrijs = document.getElementById('inkoopprijs');
    if (elPrijs) {
      const formatPrice = (raw) => {
        if (raw == null) return '';
        let s = String(raw);
        s = s.replace(/\./g, ',');            // punten → komma
        s = s.replace(/[^0-9,]/g, '');        // alleen cijfers en komma
        const i = s.indexOf(',');
        if (i !== -1) {
          const before = s.slice(0, i);
          let after = s.slice(i + 1).replace(/,/g, '');
          after = after.slice(0, 2);          // max 2 decimals
          s = before + (after.length ? ',' + after : ',');
        }
        if (s.startsWith(',')) s = '0' + s;   // ",xx" → "0,xx"
        return s;
      };

      elPrijs.addEventListener('beforeinput', (e) => {
        if (e.data === '-') e.preventDefault();  // minteken blokkeren
      });

      elPrijs.addEventListener('input', () => {
        const val = elPrijs.value;
        const formatted = formatPrice(val);
        if (formatted !== val) {
          elPrijs.value = formatted;
          const end = elPrijs.value.length;
          elPrijs.setSelectionRange(end, end);
        }
      });

      elPrijs.addEventListener('blur', () => {
        elPrijs.value = formatPrice(elPrijs.value);
      });
    }

    // Ton: alleen hele getallen
    const elTon = document.getElementById('aantalTon');
    if (elTon) {
      elTon.addEventListener('input', () => {
        elTon.value = (elTon.value || '').replace(/\D/g,'');
      });
    }

    // Postcode live mask: "1234 AB" — spatie pas tonen als er 1+ letters zijn
    const elPC = document.getElementById('postcode');
    if (elPC) {
      // Backspace over de spatie: verwijder de spatie en zet caret goed
      elPC.addEventListener('keydown', (e) => {
        if (e.key !== 'Backspace') return;
        const start = elPC.selectionStart;
        const end   = elPC.selectionEnd;
        const val   = elPC.value;

        if (start === end && start > 0 && val[start - 1] === ' ' && /^\d{4} $/.test(val.slice(0, start))) {
          e.preventDefault();
          elPC.value = val.slice(0, start - 1) + val.slice(start);
          elPC.setSelectionRange(start - 1, start - 1);
        }
      });

      // Live normalisatie: 4 cijfers + optioneel spatie + max 2 hoofdletters
      elPC.addEventListener('input', () => {
        const raw = elPC.value;
        const digits  = raw.replace(/\D/g, '').slice(0, 4);
        const letters = raw.replace(/[^a-zA-Z]/g, '').toUpperCase().slice(0, 2);

        let out = digits;
        if (letters.length) out += ' ' + letters;
        elPC.value = out;
      });

      // Bij verlaten veld: laatste nette format
      elPC.addEventListener('blur', () => {
        const raw = elPC.value;
        const digits  = raw.replace(/\D/g, '').slice(0, 4);
        const letters = raw.replace(/[^a-zA-Z]/g, '').toUpperCase().slice(0, 2);
        elPC.value = digits + (letters ? ' ' + letters : '');
      });
    }
  </script>
</body>
</html>
